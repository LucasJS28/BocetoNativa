<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nativa Green - Sistema de Cotizaciones</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <!-- Google Fonts y Font Awesome -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  body { font-family: 'Poppins', sans-serif; }
  #map { height: 400px; }
  .modal { display: none; }
  .modal.active { display: flex; }
  /* Custom color from request */
  .bg-nativa-green { background-color: #1E3B14; }
  .bg-nativa-green-hover:hover { background-color: #2a521e; }
  .text-nativa-green { color: #1E3B14; }
  .border-nativa-green { border-color: #1E3B14; }
  #progress-bar { 
    height: 4px; 
    background-color: #8BC34A; /* Changed to requested color */
    transition: width 0.3s ease; 
    position: fixed; 
    left: 0; 
    z-index: 50; 
    width: 0; 
  }
/* --- Scroll Shadow Effect for Quotations Table --- */
#quotations-container {
  position: relative;
  overflow-x: auto;
  scroll-behavior: smooth;
  border-radius: 0.5rem;
}
#quotations-container::before,
#quotations-container::after {
  content: '';
  position: absolute;
  top: 0;
  bottom: 0;
  width: 20px;
  z-index: 10;
  pointer-events: none;
  transition: opacity 0.3s ease;
}
  /* ##### NUEVO: ESTILOS PARA FLECHAS DE SCROLL INTERACTIVAS ##### */
  #quotations-wrapper {
      position: relative; /* Contexto para posicionar las flechas */
  }
  .scroll-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 30; /* Encima de la sombra y la tabla */
      background-color: #1E3B14; /* nativa-green */
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      font-size: 1.25rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.2s ease;
  }
  .scroll-arrow:hover {
      transform: translateY(-50%) scale(1.1);
  }
  .scroll-arrow.visible {
      opacity: 1;
      pointer-events: auto;
  }
  #scroll-left-btn {
      left: 8px;
  }
  #scroll-right-btn {
      right: 8px;
  }
  /* ##### FIN DE NUEVOS ESTILOS ##### */  /* Improved table styling */
  table {
    border-collapse: collapse;
    width: 100%;
  }
  th, td {
    padding: 12px 16px;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
  }
  th {
    background-color: #f3f4f6;
    color: #374151;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.9rem;
    letter-spacing: 0.05em;
  }
  tr:hover {
    background-color: #f9fafb;
  }
  tbody tr {
    transition: background-color 0.2s ease;
  }
  /* Improved Administrador styling */
  .admin-label {
    margin-left: 1rem;
    padding: 0.25rem 0.75rem;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 9999px;
    font-size: 0.85rem;
    font-weight: 500;
    color: #ffffff;
  }  /* --- Estilos para el nuevo formulario de cotización --- */
    .stepper-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    color: #a0aec0; /* gray-500 */
    transition: all 0.3s ease;
    }
    .stepper-item .step-counter {
    height: 48px;
    width: 48px;
    border-radius: 50%;
    background-color: #e2e8f0; /* gray-300 */
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    border: 3px solid #e2e8f0; /* gray-300 */
    transition: all 0.3s ease;
    }
    .stepper-item .step-name {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    }
    .stepper-item.active {
    color: #1E3B14; /* nativa-green */
    }
    .stepper-item.active .step-counter {
    border-color: #1E3B14; /* nativa-green */
    background-color: #fff;
    }
    .stepper-line {
    flex-grow: 1;
    height: 2px;
    background-color: #e2e8f0; /* gray-300 */
    }
    .form-input, .form-select {
    width: 100%;
    padding: 0.75rem 1rem;
    border: 1px solid #d2d6dc; /* gray-300 */
    border-radius: 0.5rem;
    transition: all 0.2s ease;
    background-color: #fff;
    }
    .form-input:focus, .form-select:focus {
    outline: none;
    border-color: #1E3B14;
    box-shadow: 0 0 0 2px rgba(30, 59, 20, 0.2);
    }
    .form-checkbox {
    height: 1.25rem;
    width: 1.25rem;
    border-radius: 0.25rem;
    border-color: #d2d6dc; /* gray-300 */
    color: #1E3B14; /* nativa-green */
    }
    .form-checkbox:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(30, 59, 20, 0.2);
    }
    .info-card {
    background-color: #f8fafc; /* gray-50 */
    padding: 1rem;
    border-radius: 0.75rem;
    border: 1px solid #e5e7eb; /* gray-200 */
    }
    .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: all 0.2s ease;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    }
    .btn-primary {
    background-color: #1E3B14;
    color: white;
    }
    .btn-primary:hover {
    background-color: #2a521e;
    }
    .btn-secondary {
    background-color: #e5e7eb; /* gray-200 */
    color: #374151; /* gray-700 */
    }
    .btn-secondary:hover {
    background-color: #d1d5db; /* gray-300 */
    }
    .btn-danger {
    background-color: #dc2626; /* red-600 */
    color: white;
    }
    .btn-danger:hover {
        background-color: #b91c1c; /* red-700 */
    }
    .btn-map {
        background-color: #3b82f6; /* blue-500 */
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        font-weight: 500;
        white-space: nowrap;
        transition: background-color 0.2s ease;
    }
    .btn-map:hover {
        background-color: #2563eb; /* blue-600 */
    }
</style></head>
<body class="bg-gray-100">
  <!-- Navbar -->
  <nav class="bg-nativa-green text-white p-4 shadow-lg sticky top-0 z-50">
    <div class="container mx-auto flex justify-between items-center">
      <div class="flex items-center">
  <img src="https://www.nativagreen.cl/imagenes/logo.png" alt="Nativa Green Logo" class="h-10 mr-3">
  <span class="text-xl font-bold">Nativa Green</span>
  <span class="admin-label">Administrador</span>
</div>
      <!-- Menú para escritorio -->
      <div class="hidden md:flex space-x-2">
        <button onclick="showSection('dashboard')" class="px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-chart-line mr-2"></i>Dashboard</button>
        <button onclick="showSection('clients')" class="px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-users mr-2"></i>Clientes</button>
        <button onclick="showSection('tariffs')" class="px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-tags mr-2"></i>Tarifas</button>
        <button onclick="showSection('create-quotation')" class="px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-plus-circle mr-2"></i>Crear Cotización</button>
        <button onclick="showSection('others')" class="px-3 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-cogs mr-2"></i>Otros</button>
      </div>
      <!-- Botón de menú para móvil -->
      <div class="md:hidden">
        <button id="mobile-menu-button" class="text-white focus:outline-none">
          <i class="fas fa-bars fa-lg"></i>
        </button>
      </div>
    </div>
    <!-- Menú desplegable para móvil -->
    <div id="mobile-menu" class="hidden md:hidden mt-4">
      <button onclick="showSection('dashboard')" class="block w-full text-left px-4 py-3 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-chart-line mr-2"></i>Dashboard</button>
      <button onclick="showSection('clients')" class="block w-full text-left px-4 py-3 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-users mr-2"></i>Clientes</button>
      <button onclick="showSection('tariffs')" class="block w-full text-left px-4 py-3 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-tags mr-2"></i>Tarifas</button>
      <button onclick="showSection('create-quotation')" class="block w-full text-left px-4 py-3 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-plus-circle mr-2"></i>Crear Cotización</button>
      <button onclick="showSection('others')" class="block w-full text-left px-4 py-3 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors"><i class="fas fa-cogs mr-2"></i>Otros</button>
    </div>
  </nav>
  <div id="progress-bar"></div>

  <!-- Main Content -->
  <main class="container mx-auto p-4 md:p-6">
    <!-- Dashboard -->
    <section id="dashboard" class="section">
      <h2 class="text-3xl font-bold mb-6 pb-2 border-b-2 border-nativa-green text-nativa-green"><i class="fas fa-chart-line mr-3"></i>Dashboard</h2>
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-lg flex items-center transform hover:scale-105 transition-transform">
          <i class="fas fa-folder-open text-4xl text-yellow-500 mr-4"></i>
          <div>
            <h3 class="text-lg text-gray-600">Cotizaciones Abiertas</h3>
            <p class="text-3xl font-semibold mt-1">5</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg flex items-center transform hover:scale-105 transition-transform">
          <i class="fas fa-check-circle text-4xl text-green-500 mr-4"></i>
          <div>
            <h3 class="text-lg text-gray-600">Cotizaciones Aprobadas</h3>
            <p class="text-3xl font-semibold mt-1">3</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg flex items-center transform hover:scale-105 transition-transform">
          <i class="fas fa-file-invoice text-4xl text-blue-500 mr-4"></i>
          <div>
            <h3 class="text-lg text-gray-600">Órdenes Generadas</h3>
            <p class="text-3xl font-semibold mt-1">2</p>
          </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-lg flex items-center transform hover:scale-105 transition-transform">
          <i class="fas fa-dollar-sign text-4xl text-purple-500 mr-4"></i>
          <div>
            <h3 class="text-lg text-gray-600">Ventas Concretadas</h3>
            <p class="text-3xl font-semibold mt-1">$150,000</p>
          </div>
        </div>
      </div>
      <h3 class="text-2xl mt-10 mb-4 font-bold text-gray-700">Cotizaciones Recientes</h3>
      <!-- Add Search and Filter Controls -->
      <div class="bg-white p-4 rounded-lg shadow-lg mb-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
          <div>
            <label for="search-quotations" class="block text-sm font-bold mb-2">Buscar por Código o Cliente</label>
            <input id="search-quotations" type="text" class="form-input" placeholder="Código o nombre del cliente">
          </div>
          <div>
            <label for="filter-client" class="block text-sm font-bold mb-2">Cliente</label>
            <select id="filter-client" class="form-select">
              <option value="">Todos los Clientes</option>
              <!-- Populated by JS -->
            </select>
          </div>
          <div>
            <label for="filter-date-range" class="block text-sm font-bold mb-2">Rango de Fechas</label>
            <select id="filter-date-range" class="form-select">
              <option value="">Todos los Períodos</option>
              <option value="last-week">Última Semana</option>
              <option value="last-month">Último Mes</option>
              <option value="last-3-months">Últimos 3 Meses</option>
              <option value="last-6-months">Últimos 6 Meses</option>
              <option value="last-year">Último Año</option>
              <option value="custom">Personalizado</option>
            </select>
            <div id="custom-date-range" class="hidden mt-2">
              <input id="filter-date-start" type="date" class="form-input">
              <input id="filter-date-end" type="date" class="form-input mt-2">
            </div>
          </div>
          <div>
            <label for="filter-status" class="block text-sm font-bold mb-2">Estado</label>
            <select id="filter-status" class="form-select">
              <option value="">Todos los Estados</option>
              <option value="draft">Borrador</option>
              <option value="approved">Aprobado</option>
            </select>
          </div>
        </div>
         <div class="flex items-center mt-4">
            <button id="clear-filters" class="btn btn-secondary"><i class="fas fa-times mr-2"></i>Limpiar Filtros</button>
            <!-- ##### BOTÓN NUEVO ##### -->
            <button onclick="openPaymentStatementModal()" class="btn btn-primary ml-4"><i class="fas fa-file-invoice-dollar mr-2"></i>Generar Estado de Pago</button>
         </div>
      </div>
      
  <!-- ##### NUEVO: CONTENEDOR PARA LA TABLA Y LAS FLECHAS ##### -->
  <div id="quotations-wrapper">
      <div id="quotations-container" class="bg-white rounded-lg shadow-lg overflow-x-auto">
        <table class="w-full">
          <thead>
            <tr>
              <th class="p-4 text-left font-semibold">Código</th>
              <th class="p-4 text-left font-semibold">Cliente</th>
              <th class="p-4 text-left font-semibold">Fecha</th>
              <th class="p-4 text-left font-semibold">Total</th>
              <th class="p-4 text-left font-semibold">Estado</th>
              <th class="p-4 text-left font-semibold">Acciones</th>
            </tr>
          </thead>
          <tbody id="quotations-table">
            <!-- Llenado por JS -->
          </tbody>
        </table>
      </div>
      <!-- Flechas de scroll -->
      <button id="scroll-left-btn" class="scroll-arrow"><i class="fas fa-chevron-left"></i></button>
      <button id="scroll-right-btn" class="scroll-arrow"><i class="fas fa-chevron-right"></i></button>
  </div>

</section>

<!-- Clientes -->
<section id="clients" class="section hidden">
  <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-nativa-green text-nativa-green"><i class="fas fa-users mr-3"></i>Clientes</h2>
  <button onclick="openClientModal('new')" class="btn btn-primary mb-4"><i class="fas fa-plus mr-2"></i>Nuevo Cliente</button>
  <div class="bg-white rounded-lg shadow-lg overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr>
          <th class="p-4 text-left font-semibold">Nombre</th>
          <th class="p-4 text-left font-semibold">RUC</th>
          <th class="p-4 text-left font-semibold">Contacto</th>
          <th class="p-4 text-left font-semibold">Acciones</th>
        </tr>
      </thead>
      <tbody id="clients-table">
        <!-- Llenado por JS -->
      </tbody>
    </table>
  </div>
</section>

<!-- Tarifas -->
<section id="tariffs" class="section hidden">
  <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-nativa-green text-nativa-green"><i class="fas fa-tags mr-3"></i>Tarifas</h2>
  <button onclick="openTariffModal('new')" class="btn btn-primary mb-4"><i class="fas fa-plus mr-2"></i>Nueva Tarifa</button>
  <div class="bg-white rounded-lg shadow-lg overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr>
          <th class="p-4 text-left font-semibold">Nombre</th>
          <th class="p-4 text-left font-semibold">Cliente</th>
          <th class="p-4 text-left font-semibold">Contenedor</th>
          <th class="p-4 text-left font-semibold">Precio/km</th>
          <th class="p-4 text-left font-semibold">Acciones</th>
        </tr>
      </thead>
      <tbody id="tariffs-table">
        <!-- Llenado por JS -->
      </tbody>
    </table>
  </div>
</section>

<!-- Crear Cotización (Rediseñado) -->
<section id="create-quotation" class="section hidden">
  <h2 class="text-3xl font-bold mb-6 pb-2 border-b-2 border-nativa-green text-nativa-green"><i class="fas fa-plus-circle mr-3"></i>Crear Cotización</h2>
  
  <!-- Stepper / Asistente de Pasos -->
  <div class="max-w-3xl mx-auto mb-8">
    <div class="flex items-center">
      <div id="step-indicator-1" class="stepper-item active">
        <div class="step-counter"><i class="fas fa-user-tie"></i></div>
        <div class="step-name">Información</div>
      </div>
      <div class="stepper-line"></div>
      <div id="step-indicator-2" class="stepper-item">
        <div class="step-counter"><i class="fas fa-route"></i></div>
        <div class="step-name">Ruta</div>
      </div>
      <div class="stepper-line"></div>
      <div id="step-indicator-3" class="stepper-item">
        <div class="step-counter"><i class="fas fa-calculator"></i></div>
        <div class="step-name">Cálculo</div>
      </div>
    </div>
  </div>

  <!-- Formulario Contenido en una Tarjeta -->
  <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg max-w-3xl mx-auto">
    <form id="quotation-form">
      <!-- Paso 1: Información de Cliente y Tarifa -->
      <div id="step-1">
        <h3 class="text-xl font-semibold mb-6 text-gray-800">Paso 1: Seleccione Cliente y Tarifa</h3>
        <div class="space-y-6">
          <div>
            <label for="client-id" class="block text-sm font-bold text-gray-600 mb-2">Cliente</label>
            <select id="client-id" class="form-select"></select>
          </div>
          <div>
            <label for="tariff-id" class="block text-sm font-bold text-gray-600 mb-2">Tarifa</label>
            <select id="tariff-id" class="form-select">
              <option value="">Seleccionar Tarifa</option>
            </select>
          </div>
          <div id="tariff-details-card" class="info-card hidden">
            <h4 class="font-bold text-nativa-green mb-3"><i class="fas fa-info-circle mr-2"></i>Detalles de la Tarifa Seleccionada</h4>
            <div id="tariff-details" class="text-sm grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-2">
              <p><strong>Contenedor:</strong> <span id="tariff-container">N/A</span></p>
              <p><strong>Camión:</strong> <span id="tariff-truck">N/A</span></p>
              <p><strong>Precio/Km:</strong> <span id="tariff-price-per-km">0</span> CLP</p>
              <p><strong>Precio Base:</strong> <span id="tariff-base-price">0</span> CLP</p>
            </div>
          </div>
        </div>
        <div class="mt-8 flex justify-end">
          <button type="button" onclick="nextStep()" class="btn btn-primary"><i class="fas fa-arrow-right mr-2"></i>Siguiente</button>
        </div>
      </div>

      <!-- Paso 2: Detalles de la Ruta -->
      <div id="step-2" class="hidden">
        <h3 class="text-xl font-semibold mb-6 text-gray-800">Paso 2: Defina la Ruta</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
          <div>
            <label for="origin-address" class="block text-sm font-bold text-gray-600 mb-2">Origen</label>
            <input id="origin-address" type="text" class="form-input" placeholder="Dirección de origen">
          </div>
          <div>
            <label for="dest-address" class="block text-sm font-bold text-gray-600 mb-2">Destino</label>
            <input id="dest-address" type="text" class="form-input" placeholder="Dirección de destino">
          </div>
        </div>
        <div class="mb-6">
            <label for="km" class="block text-sm font-bold text-gray-600 mb-2">Distancia (Km)</label>
            <div class="flex items-center">
                <input id="km" type="number" class="form-input w-full" placeholder="Ingrese los kilómetros">
                <button type="button" onclick="openMapModal(0)" class="btn-map ml-3"><i class="fas fa-map-marked-alt mr-2"></i>Calcular en Mapa</button>
            </div>
        </div>
        <div class="p-4 bg-gray-50 rounded-lg border">
          <label class="block text-sm font-bold text-gray-600 mb-3">Opciones de Viaje</label>
          <div class="space-y-3">
            <label class="flex items-center"><input type="checkbox" id="return-trip" class="form-checkbox"> <span class="ml-2 text-sm">Incluir Tramo de Vuelta a otro destino</span></label>
            <label class="flex items-center"><input type="checkbox" id="return-to-origin" class="form-checkbox"> <span class="ml-2 text-sm">Viaje de Ida y Vuelta al Origen</span></label>
          </div>
        </div>
        <div id="return-option-error" class="text-red-600 text-sm mt-2 font-medium hidden">
            <i class="fas fa-exclamation-circle mr-2"></i>Por favor, seleccione una opción de viaje de vuelta.
        </div>

        <div id="additional-destinations" class="mt-4"></div>
        <div class="mt-8 flex justify-between">
          <button type="button" onclick="prevStep()" class="btn btn-secondary"><i class="fas fa-arrow-left mr-2"></i>Anterior</button>
          <button type="button" onclick="nextStep()" class="btn btn-primary"><i class="fas fa-arrow-right mr-2"></i>Siguiente</button>
        </div>
      </div>

      <!-- Paso 3: Resumen y Acciones -->
      <div id="step-3" class="hidden">
        <h3 class="text-xl font-semibold mb-6 text-gray-800">Paso 3: Resumen y Guardado</h3>
         <div class="info-card">
             <h4 class="font-bold text-nativa-green mb-3"><i class="fas fa-file-invoice-dollar mr-2"></i>Resumen de Cotización</h4>
            <div id="calculation-details">
                <p class="text-gray-500">Complete los pasos anteriores para ver el cálculo.</p>
            </div>
         </div>
        <div class="mt-8 flex flex-col sm:flex-row justify-between items-center">
            <button type="button" onclick="prevStep()" class="btn btn-secondary w-full sm:w-auto mb-2 sm:mb-0"><i class="fas fa-arrow-left mr-2"></i>Anterior</button>
            <div class="w-full sm:w-auto flex flex-col sm:flex-row">
                <button type="button" onclick="generatePDF()" class="btn btn-danger w-full sm:w-auto mb-2 sm:mb-0 sm:mr-3"><i class="fas fa-file-pdf mr-2"></i>Exportar PDF</button>
                <button type="submit" class="btn btn-primary w-full sm:w-auto"><i class="fas fa-save mr-2"></i>Guardar Cotización</button>
            </div>
        </div>
      </div>
    </form>
  </div>
</section>

<!-- Others Section -->
<section id="others" class="section hidden">
  <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-nativa-green text-nativa-green"><i class="fas fa-cogs mr-3"></i>Otros</h2>
  <!-- Containers -->
  <h3 class="text-xl font-bold mb-4 text-gray-700"><i class="fas fa-box-open mr-2"></i>Contenedores</h3>
  <button onclick="openContainerModal('new')" class="btn btn-primary mb-4"><i class="fas fa-plus mr-2"></i>Nuevo Contenedor</button>
  <div class="bg-white rounded-lg shadow-lg overflow-x-auto mb-8">
    <table class="w-full">
      <thead>
        <tr>
          <th class="p-4 text-left font-semibold">Nombre</th>
          <th class="p-4 text-left font-semibold">Precio Base</th>
          <th class="p-4 text-left font-semibold">Acciones</th>
        </tr>
      </thead>
      <tbody id="containers-table">
        <!-- Filled by JS -->
      </tbody>
    </table>
  </div>
  <!-- Trucks -->
  <h3 class="text-xl font-bold mb-4 text-gray-700"><i class="fas fa-truck mr-2"></i>Camiones</h3>
  <button onclick="openTruckModal('new')" class="btn btn-primary mb-4"><i class="fas fa-plus mr-2"></i>Nuevo Camión</button>
  <div class="bg-white rounded-lg shadow-lg overflow-x-auto">
    <table class="w-full">
      <thead>
        <tr>
          <th class="p-4 text-left font-semibold">Nombre</th>
          <th class="p-4 text-left font-semibold">Capacidad (Toneladas)</th>
          <th class="p-4 text-left font-semibold">Acciones</th>
        </tr>
      </thead>
      <tbody id="trucks-table">
        <!-- Filled by JS -->
      </tbody>
    </table>
  </div>
</section>  </main>

  <!-- Modals -->
  <div id="client-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
      <h2 id="client-modal-title" class="text-xl font-bold mb-4">Nuevo Cliente</h2>
      <form id="client-form">
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Nombre</label><input id="client-name" type="text" class="form-input" required></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">RUC</label><input id="client-ruc" type="text" class="form-input"></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Contacto</label><input id="client-contact" type="text" class="form-input"></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Teléfono</label><input id="client-phone" type="text" class="form-input"></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Email</label><input id="client-email" type="email" class="form-input"></div>
        <div class="flex justify-end">
          <button type="button" onclick="closeClientModal()" class="btn btn-secondary mr-2">Cerrar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="tariff-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
      <h2 id="tariff-modal-title" class="text-xl font-bold mb-4">Nueva Tarifa</h2>
      <form id="tariff-form">
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Nombre</label><input id="tariff-name" type="text" class="form-input" required></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Cliente (opcional)</label><select id="tariff-client-id" class="form-select"><option value="">Global</option></select></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Contenedor</label><select id="tariff-container-id" class="form-select"></select></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Camión</label><select id="tariff-truck-id" class="form-select"></select></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Precio por Km</label><input id="tariff-price-per-km" type="number" step="0.01" class="form-input" required></div>
        <div class="flex justify-end">
          <button type="button" onclick="closeTariffModal()" class="btn btn-secondary mr-2">Cerrar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="container-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
      <h2 id="container-modal-title" class="text-xl font-bold mb-4">Nuevo Contenedor</h2>
      <form id="container-form">
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Nombre</label>
          <input id="container-name" type="text" class="form-input" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Precio Base</label>
          <input id="container-base-price" type="number" step="0.01" class="form-input" required>
        </div>
        <div class="flex justify-end">
          <button type="button" onclick="closeContainerModal()" class="btn btn-secondary mr-2">Cerrar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="truck-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-lg">
      <h2 id="truck-modal-title" class="text-xl font-bold mb-4">Nuevo Camión</h2>
      <form id="truck-form">
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Nombre</label>
          <input id="truck-name" type="text" class="form-input" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Capacidad (Toneladas)</label>
          <input id="truck-capacity" type="number" step="0.01" class="form-input" required>
        </div>
        <div class="flex justify-end">
          <button type="button" onclick="closeTruckModal()" class="btn btn-secondary mr-2">Cerrar</button>
          <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
      </form>
    </div>
  </div>

  <div id="map-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl">
      <h2 class="text-xl font-bold mb-4">Seleccionar Ruta</h2>
      <div id="map" class="rounded-md border"></div>
      <div class="mt-4 flex justify-between items-center">
        <p><strong>Distancia:</strong> <span id="map-distance">0 km</span></p>
        <div>
          <button onclick="closeMapModal()" class="btn btn-secondary mr-2">Cerrar</button>
          <button onclick="confirmMapSelection()" class="btn btn-primary">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ##### MODALS NUEVOS ##### -->
  <div id="payment-statement-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-3xl">
        <h2 class="text-xl font-bold mb-4">Generar Estado de Pago</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
                <label for="payment-client-filter" class="block text-sm font-bold mb-2">Cliente</label>
                <select id="payment-client-filter" class="form-select">
                    <option value="">Seleccione un cliente</option>
                </select>
            </div>
            <!-- ##### CÓDIGO NUEVO Y MEJORADO ##### -->
            <div>
                <label class="block text-sm font-bold mb-2">Rango de Fechas (Opcional)</label>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label for="payment-date-start" class="text-xs font-medium text-gray-500">Desde</label>
                        <input type="date" id="payment-date-start" class="form-input w-full p-2 text-sm">
                    </div>
                    <div>
                        <label for="payment-date-end" class="text-xs font-medium text-gray-500">Hasta</label>
                        <input type="date" id="payment-date-end" class="form-input w-full p-2 text-sm">
                    </div>
                </div>
            </div>
        </div>

        <div class="max-h-80 overflow-y-auto border rounded-lg">
            <table class="w-full">
                <thead>
                    <tr>
                        <th class="p-3 text-left font-semibold">Código</th>
                        <th class="p-3 text-left font-semibold">Fecha</th>
                        <th class="p-3 text-left font-semibold">Total</th>
                        <th class="p-3 text-center font-semibold"><i class="fas fa-check"></i></th>
                    </tr>
                </thead>
                <tbody id="payment-quotations-table">
                    <tr><td colspan="4" class="text-center p-6 text-gray-500">Seleccione un cliente para ver sus cotizaciones aprobadas.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="flex justify-end mt-6">
            <button type="button" onclick="closePaymentStatementModal()" class="btn btn-secondary mr-2">Cerrar</button>
            <button type="button" onclick="generatePaymentSummary()" class="btn btn-primary">Generar Estado de Pago</button>
        </div>
    </div>
  </div>

  <div id="payment-summary-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
    <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md text-center">
        <h2 class="text-2xl font-bold mb-4 text-nativa-green">Resumen de Pago</h2>
        
        <div class="info-card text-left mb-6">
            <p class="mb-2"><strong>Cliente:</strong> <span id="summary-client-name"></span></p>
            <p><strong>RUC:</strong> <span id="summary-client-ruc"></span></p>
        </div>
        
        <div class="bg-gray-100 p-4 rounded-lg">
            <p class="text-lg text-gray-600">Total a Pagar</p>
            <p id="summary-total-amount" class="text-4xl font-bold text-nativa-green mt-1"></p>
        </div>

        <div class="flex justify-center mt-8">
            <button type="button" onclick="closePaymentSummaryModal()" class="btn btn-secondary">Cerrar</button>
        </div>
    </div>
  </div>


  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script>
// --- START STEPPER SCRIPT ---
let currentStep = 1;

function showStep(stepNumber) {
  document.querySelectorAll('[id^="step-"]').forEach(step => step.classList.add('hidden'));
  document.getElementById(`step-${stepNumber}`).classList.remove('hidden');

  document.querySelectorAll('.stepper-item').forEach(item => item.classList.remove('active'));
  for (let i = 1; i <= stepNumber; i++) {
    document.getElementById(`step-indicator-${i}`).classList.add('active');
  }

  if (stepNumber === 3) {
      calculateQuotation();
  }
}

function showReturnOptionError() {
    const errorEl = document.getElementById('return-option-error');
    errorEl.classList.remove('hidden');
    setTimeout(() => {
        errorEl.classList.add('hidden');
    }, 3000);
}

function nextStep() {
  if (currentStep === 2) {
    const returnTrip = document.getElementById('return-trip').checked;
    const returnToOrigin = document.getElementById('return-to-origin').checked;
    if (!returnTrip && !returnToOrigin) {
      // For now, let's assume it's a one-way trip if nothing is checked
      // showReturnOptionError(); 
      // return;
    }
  }

  if (currentStep < 3) {
    currentStep++;
    showStep(currentStep);
  }
}

function prevStep() {
  if (currentStep > 1) {
    currentStep--;
    showStep(currentStep);
  }
}
// --- END STEPPER SCRIPT ---

 // --- START RESPONSIVE NAVBAR SCRIPT ---
const mobileMenuButton = document.getElementById('mobile-menu-button');
const mobileMenu = document.getElementById('mobile-menu');
mobileMenuButton.addEventListener('click', () => {
  mobileMenu.classList.toggle('hidden');
});
const mobileMenuLinks = mobileMenu.querySelectorAll('button');
mobileMenuLinks.forEach(link => {
  link.addEventListener('click', () => {
    mobileMenu.classList.add('hidden');
  });
});
// --- END RESPONSIVE NAVBAR SCRIPT ---

// --- START APPLICATION LOGIC SCRIPT ---
const clients = [
  { id: 1, name: "Cliente A", ruc: "12345678-9", contactName: "Juan Pérez", contactPhone: "123456789", email: "juan@cliente.com" },
  { id: 2, name: "Cliente B", ruc: "98765432-1", contactName: "Ana Gómez", contactPhone: "987654321", email: "ana@cliente.com" },
];
const containers = [
  { id: 1, name: "Contenedor 20 pies", basePrice: 50000 },
  { id: 2, name: "Contenedor 40 pies", basePrice: 80000 },
];
const trucks = [
  { id: 1, name: "Camión 10T", capacityTons: 10 },
  { id: 2, name: "Camión 20T", capacityTons: 20 },
];
const tariffs = [
  { id: 1, name: "Tarifa Estándar", clientId: null, containerId: 1, truckId: 1, pricePerKm: 1000 },
  { id: 2, name: "Tarifa Cliente A", clientId: 1, containerId: 1, truckId: 1, pricePerKm: 900 },
];
const quotations = [
  { id: 1, code: "QUOT-001", clientId: 1, date: "2025-09-12", total: 150000, status: "draft", tariffId: 1 },
  { id: 2, code: "QUOT-002", clientId: 2, date: "2025-08-28", total: 200000, status: "approved", tariffId: 2 },
  { id: 3, code: "QUOT-003", clientId: 1, date: "2025-08-13", total: 180000, status: "approved", tariffId: 1 },
  { id: 4, code: "QUOT-004", clientId: 2, date: "2025-07-29", total: 220000, status: "approved", tariffId: 2 },
  { id: 5, code: "QUOT-005", clientId: 1, date: "2025-07-14", total: 140000, status: "draft", tariffId: 1 },
  { id: 6, code: "QUOT-006", clientId: 2, date: "2025-06-29", total: 190000, status: "approved", tariffId: 2 },
  { id: 7, code: "QUOT-007", clientId: 1, date: "2025-06-14", total: 160000, status: "approved", tariffId: 1 },
  { id: 8, code: "QUOT-008", clientId: 2, date: "2025-05-30", total: 210000, status: "approved", tariffId: 2 },
  { id: 9, code: "QUOT-009", clientId: 1, date: "2025-05-15", total: 170000, status: "draft", tariffId: 1 },
  { id: 10, code: "QUOT-010", clientId: 2, date: "2025-04-30", total: 230000, status: "approved", tariffId: 2 },
];

let map, waypoints = [], control;
let routes = [
  { origin: null, originName: '', destination: null, destinationName: '', km: 0 }
];
let currentRouteIndex = 0;

function showSection(sectionId) {
  document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
  document.getElementById(sectionId).classList.remove('hidden');
}

function populateClients() {
  const table = document.getElementById('clients-table');
  table.innerHTML = clients.map(client => `
    <tr class="border-b hover:bg-gray-50">
      <td class="p-4">${client.name}</td>
      <td class="p-4">${client.ruc || ''}</td>
      <td class="p-4">${client.contactName || ''}</td>
      <td class="p-4">
        <button onclick="openClientModal('edit', ${client.id})" class="text-blue-500 hover:underline"><i class="fas fa-edit"></i></button>
        <button onclick="deleteClient(${client.id})" class="text-red-500 ml-3 hover:underline"><i class="fas fa-trash"></i></button>
      </td>
    </tr>
  `).join('');

  const select = document.getElementById('client-id');
  select.innerHTML = '<option value="">Seleccionar Cliente</option>' + 
    clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('');

  const tariffSelect = document.getElementById('tariff-client-id');
  tariffSelect.innerHTML = '<option value="">Global</option>' + 
    clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('');
}

function populateTariffs() {
  const table = document.getElementById('tariffs-table');
  table.innerHTML = tariffs.map(tariff => `
    <tr class="border-b hover:bg-gray-50">
      <td class="p-4">${tariff.name}</td>
      <td class="p-4">${tariff.clientId ? clients.find(c => c.id === tariff.clientId)?.name : 'Global'}</td>
      <td class="p-4">${containers.find(c => c.id === tariff.containerId)?.name}</td>
      <td class="p-4">${tariff.pricePerKm}</td>
      <td class="p-4">
        <button onclick="openTariffModal('edit', ${tariff.id})" class="text-blue-500 hover:underline"><i class="fas fa-edit"></i></button>
        <button onclick="deleteTariff(${tariff.id})" class="text-red-500 ml-3 hover:underline"><i class="fas fa-trash"></i></button>
      </td>
    </tr>
  `).join('');

  const tariffSelect = document.getElementById('tariff-id');
  tariffSelect.innerHTML = '<option value="">Seleccionar Tarifa</option>' + 
    tariffs.map(tariff => {
      const clientName = tariff.clientId ? clients.find(c => c.id === tariff.clientId)?.name : 'Global';
      return `<option value="${tariff.id}">${tariff.name} (${clientName})</option>`;
    }).join('');

  const tariffContainerSelect = document.getElementById('tariff-container-id');
  tariffContainerSelect.innerHTML = '<option value="">Seleccionar Contenedor</option>' + 
    containers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

  const tariffTruckSelect = document.getElementById('tariff-truck-id');
  tariffTruckSelect.innerHTML = '<option value="">Seleccionar Camión</option>' + 
    trucks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
}

function populateClientFilter() {
  const filterClient = document.getElementById('filter-client');
  filterClient.innerHTML = '<option value="">Todos los Clientes</option>' + 
    clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('');
}

function getDateRange(filterValue) {
  const currentDate = new Date('2025-09-12'); // Fixed date for consistent demo
  let startDate, endDate;
  endDate = currentDate;

  switch (filterValue) {
    case 'last-week':
      startDate = new Date(currentDate);
      startDate.setDate(currentDate.getDate() - 7);
      break;
    case 'last-month':
      startDate = new Date(currentDate);
      startDate.setMonth(currentDate.getMonth() - 1);
      break;
    case 'last-3-months':
      startDate = new Date(currentDate);
      startDate.setMonth(currentDate.getMonth() - 3);
      break;
    case 'last-6-months':
      startDate = new Date(currentDate);
      startDate.setMonth(currentDate.getMonth() - 6);
      break;
    case 'last-year':
      startDate = new Date(currentDate);
      startDate.setFullYear(currentDate.getFullYear() - 1);
      break;
    case 'custom':
      const start = document.getElementById('filter-date-start').value;
      const end = document.getElementById('filter-date-end').value;
      if (start && end) {
        startDate = new Date(start);
        endDate = new Date(end);
      } else {
        return null;
      }
      break;
    default:
      return null;
  }
  return { start: startDate, end: endDate };
}

// ##### NUEVO: SEPARACIÓN DE LA LÓGICA DE INDICADORES DE SCROLL #####
function updateScrollIndicators() {
    const container = document.getElementById('quotations-container');
    const scrollLeftBtn = document.getElementById('scroll-left-btn');
    const scrollRightBtn = document.getElementById('scroll-right-btn');

    if (!container || !scrollLeftBtn || !scrollRightBtn) return;

    const scrollLeft = container.scrollLeft;
    const maxScroll = container.scrollWidth - container.clientWidth;

    // Control de flechas
    scrollLeftBtn.classList.toggle('visible', scrollLeft > 0);
    scrollRightBtn.classList.toggle('visible', maxScroll - scrollLeft > 1);
}

function formatCurrency(value) {
  return value.toLocaleString('es-CL', { style: 'currency', currency: 'CLP' });
}

function populateQuotations() {
  const searchQuery = document.getElementById('search-quotations')?.value.toLowerCase() || '';
  const filterClient = document.getElementById('filter-client')?.value || '';
  const filterStatus = document.getElementById('filter-status')?.value || '';
  const filterDateRangeValue = document.getElementById('filter-date-range')?.value || '';

  let filteredQuotations = quotations;

  if (filterClient) {
    filteredQuotations = filteredQuotations.filter(q => q.clientId === parseInt(filterClient));
  }
  if (filterStatus) {
    filteredQuotations = filteredQuotations.filter(q => q.status === filterStatus);
  }
  if (filterDateRangeValue) {
    const dateRange = getDateRange(filterDateRangeValue);
    if (dateRange) {
        // Adjust end date to include the whole day
        dateRange.end.setHours(23, 59, 59, 999);
        filteredQuotations = filteredQuotations.filter(q => {
            const quoteDate = new Date(q.date);
            return quoteDate >= dateRange.start && quoteDate <= dateRange.end;
        });
    }
  }

  if (searchQuery) {
    filteredQuotations = filteredQuotations.filter(q => {
      const clientName = clients.find(c => c.id === q.clientId)?.name.toLowerCase() || '';
      return q.code.toLowerCase().includes(searchQuery) || clientName.includes(searchQuery);
    });
  }

  const table = document.getElementById('quotations-table');
  if(filteredQuotations.length === 0){
      table.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-gray-500">No se encontraron cotizaciones con los filtros aplicados.</td></tr>`;
      return;
  }

  table.innerHTML = filteredQuotations.map(q => `
    <tr class="border-b hover:bg-gray-50">
      <td class="p-4">${q.code}</td>
      <td class="p-4">${clients.find(c => c.id === q.clientId)?.name || 'N/A'}</td>
      <td class="p-4">${new Date(q.date).toLocaleDateString('es-CL')}</td>
      <td class="p-4">${formatCurrency(q.total)}</td>
      <td class="p-4">
        <select onchange="updateQuotationStatus(${q.id}, this.value)" class="form-select text-sm p-1 ${q.status === 'approved' ? 'bg-green-100 text-green-800 border-green-300' : 'bg-yellow-100 text-yellow-800 border-yellow-300'}">
          <option value="draft" ${q.status === 'draft' ? 'selected' : ''}>Borrador</option>
          <option value="approved" ${q.status === 'approved' ? 'selected' : ''}>Aprobado</option>
        </select>
      </td>
      <td class="p-4">
        <button onclick="viewQuotation(${q.id})" class="text-blue-500 hover:underline"><i class="fas fa-eye"></i></button>
        <button onclick="generatePDF(${q.id})" class="text-red-500 ml-3 hover:underline"><i class="fas fa-file-pdf"></i></button>
      </td>
    </tr>
  `).join('');

  setTimeout(updateScrollIndicators, 0);
}

function updateQuotationStatus(id, newStatus) {
  const quotation = quotations.find(q => q.id === id);
  if (quotation) {
    quotation.status = newStatus;
    populateQuotations();
  }
}

function populateContainers() {
  const table = document.getElementById('containers-table');
  table.innerHTML = containers.map(container => `
    <tr class="border-b hover:bg-gray-50">
      <td class="p-4">${container.name}</td>
      <td class="p-4">${formatCurrency(container.basePrice)}</td>
      <td class="p-4">
        <button onclick="openContainerModal('edit', ${container.id})" class="text-blue-500 hover:underline"><i class="fas fa-edit"></i></button>
        <button onclick="deleteContainer(${container.id})" class="text-red-500 ml-3 hover:underline"><i class="fas fa-trash"></i></button>
      </td>
    </tr>
  `).join('');
}

function populateTrucks() {
  const table = document.getElementById('trucks-table');
  table.innerHTML = trucks.map(truck => `
    <tr class="border-b hover:bg-gray-50">
      <td class="p-4">${truck.name}</td>
      <td class="p-4">${truck.capacityTons}</td>
      <td class="p-4">
        <button onclick="openTruckModal('edit', ${truck.id})" class="text-blue-500 hover:underline"><i class="fas fa-edit"></i></button>
        <button onclick="deleteTruck(${truck.id})" class="text-red-500 ml-3 hover:underline"><i class="fas fa-trash"></i></button>
      </td>
    </tr>
  `).join('');
}

let currentClientId = null;
function openClientModal(mode, id = null) {
  currentClientId = id;
  document.getElementById('client-modal-title').textContent = mode === 'new' ? 'Nuevo Cliente' : 'Editar Cliente';
  document.getElementById('client-form').reset();
  if (id) {
    const client = clients.find(c => c.id === id);
    document.getElementById('client-name').value = client.name;
    document.getElementById('client-ruc').value = client.ruc || '';
    document.getElementById('client-contact').value = client.contactName || '';
    document.getElementById('client-phone').value = client.contactPhone || '';
    document.getElementById('client-email').value = client.email || '';
  }
  document.getElementById('client-modal').classList.add('active');
}

function closeClientModal() {
  document.getElementById('client-modal').classList.remove('active');
}

document.getElementById('client-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const client = {
    id: currentClientId || Date.now(),
    name: document.getElementById('client-name').value,
    ruc: document.getElementById('client-ruc').value,
    contactName: document.getElementById('client-contact').value,
    contactPhone: document.getElementById('client-phone').value,
    email: document.getElementById('client-email').value,
  };
  if (currentClientId) {
    const index = clients.findIndex(c => c.id === currentClientId);
    clients[index] = client;
  } else {
    clients.push(client);
  }
  populateClients();
  populateClientFilter();
  closeClientModal();
});

function deleteClient(id) {
  if (confirm('¿Está seguro de que desea eliminar este cliente?')) {
    const index = clients.findIndex(c => c.id === id);
    clients.splice(index, 1);
    populateClients();
    populateClientFilter();
  }
}

let currentTariffId = null;
function openTariffModal(mode, id = null) {
  currentTariffId = id;
  document.getElementById('tariff-modal-title').textContent = mode === 'new' ? 'Nueva Tarifa' : 'Editar Tarifa';
  document.getElementById('tariff-form').reset();
  if (id) {
    const tariff = tariffs.find(t => t.id === id);
    document.getElementById('tariff-name').value = tariff.name;
    document.getElementById('tariff-client-id').value = tariff.clientId || '';
    document.getElementById('tariff-container-id').value = tariff.containerId;
    document.getElementById('tariff-truck-id').value = tariff.truckId;
    document.getElementById('tariff-price-per-km').value = tariff.pricePerKm;
  }
  document.getElementById('tariff-modal').classList.add('active');
}

function closeTariffModal() {
  document.getElementById('tariff-modal').classList.remove('active');
}

document.getElementById('tariff-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const tariff = {
    id: currentTariffId || Date.now(),
    name: document.getElementById('tariff-name').value,
    clientId: parseInt(document.getElementById('tariff-client-id').value) || null,
    containerId: parseInt(document.getElementById('tariff-container-id').value),
    truckId: parseInt(document.getElementById('tariff-truck-id').value),
    pricePerKm: parseFloat(document.getElementById('tariff-price-per-km').value),
  };
  if (currentTariffId) {
    const index = tariffs.findIndex(t => t.id === currentTariffId);
    tariffs[index] = tariff;
  } else {
    tariffs.push(tariff);
  }
  populateTariffs();
  closeTariffModal();
});

function deleteTariff(id) {
  if (confirm('¿Está seguro de que desea eliminar esta tarifa?')) {
    const index = tariffs.findIndex(t => t.id === id);
    tariffs.splice(index, 1);
    populateTariffs();
  }
}

let currentContainerId = null;
function openContainerModal(mode, id = null) {
  currentContainerId = id;
  document.getElementById('container-modal-title').textContent = mode === 'new' ? 'Nuevo Contenedor' : 'Editar Contenedor';
  document.getElementById('container-form').reset();
  if (id) {
    const container = containers.find(c => c.id === id);
    document.getElementById('container-name').value = container.name;
    document.getElementById('container-base-price').value = container.basePrice;
  }
  document.getElementById('container-modal').classList.add('active');
}

function closeContainerModal() {
  document.getElementById('container-modal').classList.remove('active');
}

document.getElementById('container-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const container = {
    id: currentContainerId || Date.now(),
    name: document.getElementById('container-name').value,
    basePrice: parseFloat(document.getElementById('container-base-price').value),
  };
  if (currentContainerId) {
    const index = containers.findIndex(c => c.id === currentContainerId);
    containers[index] = container;
  } else {
    containers.push(container);
  }
  populateContainers();
  populateTariffs();
  closeContainerModal();
});

function deleteContainer(id) {
  if (confirm('¿Está seguro de que desea eliminar este contenedor?')) {
    const index = containers.findIndex(c => c.id === id);
    containers.splice(index, 1);
    populateContainers();
    populateTariffs();
  }
}

let currentTruckId = null;
function openTruckModal(mode, id = null) {
  currentTruckId = id;
  document.getElementById('truck-modal-title').textContent = mode === 'new' ? 'Nuevo Camión' : 'Editar Camión';
  document.getElementById('truck-form').reset();
  if (id) {
    const truck = trucks.find(t => t.id === id);
    document.getElementById('truck-name').value = truck.name;
    document.getElementById('truck-capacity').value = truck.capacityTons;
  }
  document.getElementById('truck-modal').classList.add('active');
}

function closeTruckModal() {
  document.getElementById('truck-modal').classList.remove('active');
}

document.getElementById('truck-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const truck = {
    id: currentTruckId || Date.now(),
    name: document.getElementById('truck-name').value,
    capacityTons: parseFloat(document.getElementById('truck-capacity').value),
  };
  if (currentTruckId) {
    const index = trucks.findIndex(t => t.id === currentTruckId);
    trucks[index] = truck;
  } else {
    trucks.push(truck);
  }
  populateTrucks();
  populateTariffs();
  closeTruckModal();
});

function deleteTruck(id) {
  if (confirm('¿Está seguro de que desea eliminar este camión?')) {
    const index = trucks.findIndex(t => t.id === id);
    trucks.splice(index, 1);
    populateTrucks();
    populateTariffs();
  }
}

function updateTariffDetails() {
  const tariffId = parseInt(document.getElementById('tariff-id').value);
  const tariff = tariffs.find(t => t.id === tariffId);
  const tariffDetailsCard = document.getElementById('tariff-details-card');
  
  if (tariff) {
    const container = containers.find(c => c.id === tariff.containerId);
    document.getElementById('tariff-container').textContent = container ? container.name : 'N/A';
    document.getElementById('tariff-truck').textContent = trucks.find(t => t.id === tariff.truckId)?.name || 'N/A';
    document.getElementById('tariff-price-per-km').textContent = tariff.pricePerKm.toLocaleString('es-CL');
    document.getElementById('tariff-base-price').textContent = container ? container.basePrice.toLocaleString('es-CL') : '0';
    tariffDetailsCard.classList.remove('hidden');
  } else {
    document.getElementById('tariff-container').textContent = 'N/A';
    document.getElementById('tariff-truck').textContent = 'N/A';
    document.getElementById('tariff-price-per-km').textContent = '0';
    document.getElementById('tariff-base-price').textContent = '0';
    tariffDetailsCard.classList.add('hidden');
  }
}

function updateReturnTripFields() {
  const returnTrip = document.getElementById('return-trip').checked;
  const returnToOrigin = document.getElementById('return-to-origin').checked;
  const additionalDestinations = document.getElementById('additional-destinations');
  additionalDestinations.innerHTML = '';

  if (returnTrip && !returnToOrigin) {
    routes[1] = routes[1] || { origin: routes[0].destination, originName: routes[0].destinationName, destination: null, destinationName: '', km: 0 };
    additionalDestinations.innerHTML = `
      <div class="p-4 bg-gray-50 rounded-lg mt-4 border">
        <h4 class="text-md font-bold text-gray-700 mb-3">Tramo de Vuelta</h4>
        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-600 mb-2">Destino de Vuelta</label>
          <input id="dest-address-1" type="text" class="form-input" placeholder="Ingrese el destino de vuelta" value="${routes[1].destinationName || ''}">
        </div>
        <div class="flex items-center">
          <label class="block text-sm font-bold text-gray-600 mr-2 w-1/4">Km Vuelta</label>
          <input id="km-1" type="number" class="form-input w-3/4" placeholder="Kilómetros" value="${routes[1].km || ''}">
          <button type="button" onclick="openMapModal(1)" class="btn-map ml-3"><i class="fas fa-map-marker-alt mr-2"></i>Mapa</button>
        </div>
      </div>
    `;
    document.getElementById('dest-address-1').addEventListener('input', () => {
      routes[1].destinationName = document.getElementById('dest-address-1').value;
    });
    document.getElementById('km-1').addEventListener('input', () => {
      const kmValue = Math.round(parseFloat(document.getElementById('km-1').value) || 0);
      routes[1].km = kmValue;
      document.getElementById('km-1').value = kmValue;
      calculateQuotation();
    });
  } else {
    routes = [routes[0]];
  }
}

function openMapModal(routeIndex) {
  currentRouteIndex = routeIndex;
  document.getElementById('map-modal').classList.add('active');
  
  setTimeout(() => {
    if (!map) {
      map = L.map('map').setView([-33.4489, -70.6693], 13); // Santiago, Chile
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);
    } else {
      map.invalidateSize();
    }

    waypoints = [];
    if (control) {
      map.removeControl(control);
      control = null;
    }
    map.eachLayer(function (layer) {
      if (layer instanceof L.Marker || layer instanceof L.Polyline) {
        map.removeLayer(layer);
      }
    });

    document.getElementById('map-distance').textContent = '0 km';
    map.on('click', function(e) {
        waypoints.push(e.latlng);
        L.marker(e.latlng).addTo(map);
        if (waypoints.length === 2) {
          if (control) map.removeControl(control);
          control = L.Routing.control({
            waypoints: waypoints,
            routeWhileDragging: false,
            show: false,
            addWaypoints: false,
            lineOptions: { styles: [{ color: '#1E3B14', opacity: 0.8, weight: 6 }] },
            createMarker: () => null
          }).addTo(map);
          control.on('routesfound', function(ev) {
            var distancia = ev.routes[0].summary.totalDistance / 1000;
            document.getElementById('map-distance').textContent = `${distancia.toFixed(1)} km`;
          });
        }
    });
  }, 100);
}

function closeMapModal() {
  document.getElementById('map-modal').classList.remove('active');
  if (map) {
    map.off('click');
  }
}

async function getAddressFromLatLng(lat, lng) {
    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
        const data = await response.json();
        return data.display_name || `Lat: ${lat.toFixed(4)}, Lon: ${lng.toFixed(4)}`;
    } catch(err) {
        console.error("Error fetching address:", err);
        return `Lat: ${lat.toFixed(4)}, Lon: ${lng.toFixed(4)}`;
    }
}

async function confirmMapSelection() {
  if (waypoints.length === 2) {
    const distancia = parseFloat(document.getElementById('map-distance').textContent);
    const roundedDistance = Math.round(distancia);
    routes[currentRouteIndex].km = roundedDistance;
    routes[currentRouteIndex].origin = waypoints[0];
    routes[currentRouteIndex].destination = waypoints[1];

    const [originName, destName] = await Promise.all([
        getAddressFromLatLng(waypoints[0].lat, waypoints[0].lng),
        getAddressFromLatLng(waypoints[1].lat, waypoints[1].lng)
    ]);
    
    if (currentRouteIndex === 0) {
        routes[0].originName = originName;
        routes[0].destinationName = destName;
        document.getElementById('origin-address').value = originName;
        document.getElementById('dest-address').value = destName;
    } else if (currentRouteIndex === 1) {
        routes[1].destinationName = destName;
        document.getElementById('dest-address-1').value = destName;
    }

    document.getElementById(`km${currentRouteIndex > 0 ? '-' + currentRouteIndex : ''}`).value = roundedDistance;
    closeMapModal();
  } else {
    alert('Selecciona dos puntos en el mapa para calcular la distancia.');
  }
}

function calculateQuotation() {
  const tariffId = parseInt(document.getElementById('tariff-id').value);
  const calculationDetails = document.getElementById('calculation-details');
  const tariff = tariffs.find(t => t.id === tariffId);

  if (!tariff) {
    calculationDetails.innerHTML = '<p class="text-gray-500">Complete los pasos anteriores para ver el cálculo.</p>';
    return;
  }
  
  const container = containers.find(c => c.id === tariff.containerId);
  if (!container) return;
  
  const returnTrip = document.getElementById('return-trip').checked;
  const returnToOrigin = document.getElementById('return-to-origin').checked;
  let totalKm = parseFloat(document.getElementById('km').value) || 0;
  let costoKmDetails = `<div class="flex justify-between"><span>Costo Tramo Ida (${totalKm} km):</span> <span>${formatCurrency(tariff.pricePerKm * totalKm)}</span></div>`;
  
  if(returnToOrigin) {
    totalKm *= 2;
    costoKmDetails = `<div class="flex justify-between"><span>Costo Tramo Ida y Vuelta (${totalKm} km):</span> <span>${formatCurrency(tariff.pricePerKm * totalKm)}</span></div>`;
  } else if (returnTrip) {
      const kmReturn = parseFloat(document.getElementById('km-1')?.value) || 0;
      costoKmDetails += `<div class="flex justify-between"><span>Costo Tramo Vuelta (${kmReturn} km):</span> <span>${formatCurrency(tariff.pricePerKm * kmReturn)}</span></div>`;
      totalKm += kmReturn;
  }

  const costoContenedor = container.basePrice;
  const subtotal = (tariff.pricePerKm * totalKm) + costoContenedor;
  const iva = subtotal * 0.19;
  const total = subtotal + iva;

  calculationDetails.innerHTML = `
    <div class="space-y-2 text-sm text-gray-700">
      ${costoKmDetails}
      <div class="flex justify-between"><span>Costo Base Contenedor:</span> <span>${formatCurrency(costoContenedor)}</span></div>
      <div class="flex justify-between font-semibold mt-2 pt-2 border-t"><span>Subtotal:</span> <span>${formatCurrency(subtotal)}</span></div>
      <div class="flex justify-between"><span>IVA (19%):</span> <span>${formatCurrency(iva)}</span></div>
      <div class="flex justify-between text-lg font-bold text-nativa-green mt-2 pt-2 border-t"><span>Total:</span> <span>${formatCurrency(total)}</span></div>
    </div>
  `;
}

document.getElementById('quotation-form').addEventListener('submit', (e) => {
  e.preventDefault();
  const tariffId = parseInt(document.getElementById('tariff-id').value);
  if (!tariffId) {
    alert('Por favor, seleccione una tarifa válida.');
    return;
  }
  const totalText = document.querySelector('#calculation-details span:last-child').textContent;
  const totalValue = parseFloat(totalText.replace(/\$|\./g, '').replace(',', '.'));
  const today = new Date().toISOString().split('T')[0];

  const quotation = {
    id: Date.now(),
    code: `QUOT-${Date.now().toString().slice(-4)}`,
    clientId: parseInt(document.getElementById('client-id').value),
    date: today,
    tariffId: tariffId,
    total: totalValue,
    status: 'draft',
  };
  quotations.unshift(quotation); // Add to the beginning
  populateQuotations();
  alert('Cotización guardada exitosamente.');
  showSection('dashboard');
});

function generatePDF(id) {
  alert(`Generando PDF para cotización... (Esta es una función de demostración)`);
}

function viewQuotation(id) {
  alert(`Mostrando detalles de la cotización... (Esta es una función de demostración)`);
}

// --- START PAYMENT STATEMENT LOGIC ---
function openPaymentStatementModal() {
    const modal = document.getElementById('payment-statement-modal');
    const clientSelect = document.getElementById('payment-client-filter');
    
    clientSelect.innerHTML = '<option value="">Seleccione un cliente</option>' +
        clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

    document.getElementById('payment-date-start').value = '';
    document.getElementById('payment-date-end').value = '';
    
    document.getElementById('payment-quotations-table').innerHTML = 
        `<tr><td colspan="4" class="text-center p-6 text-gray-500">Seleccione un cliente para ver sus cotizaciones aprobadas.</td></tr>`;

    modal.classList.add('active');
}

function closePaymentStatementModal() {
    document.getElementById('payment-statement-modal').classList.remove('active');
}

function filterPaymentQuotations() {
    const clientId = parseInt(document.getElementById('payment-client-filter').value);
    const startDate = document.getElementById('payment-date-start').value;
    const endDate = document.getElementById('payment-date-end').value;
    const tableBody = document.getElementById('payment-quotations-table');

    if (!clientId) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-gray-500">Seleccione un cliente.</td></tr>`;
        return;
    }
    
    let approvedQuotations = quotations.filter(q => q.clientId === clientId && q.status === 'approved');

    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        end.setHours(23, 59, 59, 999); // Include the whole end day
        approvedQuotations = approvedQuotations.filter(q => {
            const quoteDate = new Date(q.date);
            return quoteDate >= start && quoteDate <= end;
        });
    }

    if (approvedQuotations.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="4" class="text-center p-6 text-gray-500">No se encontraron cotizaciones aprobadas para este cliente/rango.</td></tr>`;
        return;
    }

    tableBody.innerHTML = approvedQuotations.map(q => `
        <tr class="border-b hover:bg-gray-50">
            <td class="p-3">${q.code}</td>
            <td class="p-3">${new Date(q.date).toLocaleDateString('es-CL')}</td>
            <td class="p-3">${formatCurrency(q.total)}</td>
            <td class="p-3 text-center">
                <input type="checkbox" class="form-checkbox h-5 w-5" data-quotation-id="${q.id}" data-total="${q.total}">
            </td>
        </tr>
    `).join('');
}

function generatePaymentSummary() {
    const selectedCheckboxes = document.querySelectorAll('#payment-quotations-table input[type="checkbox"]:checked');
    if (selectedCheckboxes.length === 0) {
        alert("Por favor, seleccione al menos una cotización.");
        return;
    }

    let totalAmount = 0;
    selectedCheckboxes.forEach(checkbox => {
        totalAmount += parseFloat(checkbox.dataset.total);
    });
    
    const clientId = parseInt(document.getElementById('payment-client-filter').value);
    const client = clients.find(c => c.id === clientId);

    document.getElementById('summary-client-name').textContent = client.name;
    document.getElementById('summary-client-ruc').textContent = client.ruc || 'N/A';
    document.getElementById('summary-total-amount').textContent = formatCurrency(totalAmount);

    closePaymentStatementModal();
    document.getElementById('payment-summary-modal').classList.add('active');
}

function closePaymentSummaryModal() {
    document.getElementById('payment-summary-modal').classList.remove('active');
}
// --- END PAYMENT STATEMENT LOGIC ---


document.addEventListener('DOMContentLoaded', () => {
  populateClients();
  populateTariffs();
  populateQuotations();
  populateContainers();
  populateTrucks();
  populateClientFilter();
  showSection('dashboard');

  const quotationsContainer = document.getElementById('quotations-container');
  const scrollLeftBtn = document.getElementById('scroll-left-btn');
  const scrollRightBtn = document.getElementById('scroll-right-btn');

  quotationsContainer.addEventListener('scroll', updateScrollIndicators);
  window.addEventListener('resize', updateScrollIndicators); 

  scrollLeftBtn.addEventListener('click', () => {
      quotationsContainer.scrollBy({ left: -300, behavior: 'smooth' });
  });
  scrollRightBtn.addEventListener('click', () => {
      quotationsContainer.scrollBy({ left: 300, behavior: 'smooth' });
  });

  document.getElementById('filter-date-range').addEventListener('change', (e) => {
    document.getElementById('custom-date-range').classList.toggle('hidden', e.target.value !== 'custom');
    if(e.target.value !== 'custom'){
        document.getElementById('filter-date-start').value = '';
        document.getElementById('filter-date-end').value = '';
    }
    populateQuotations();
  });

  ['client-id', 'tariff-id'].forEach(id => {
    document.getElementById(id).addEventListener('change', updateTariffDetails);
  });
  
  const kmInput = document.getElementById('km');
  kmInput.addEventListener('input', () => {
    routes[0].km = parseFloat(kmInput.value) || 0;
  });
  
  const returnTripCheckbox = document.getElementById('return-trip');
  const returnToOriginCheckbox = document.getElementById('return-to-origin');
  returnTripCheckbox.addEventListener('change', () => {
    if (returnTripCheckbox.checked) returnToOriginCheckbox.checked = false;
    updateReturnTripFields();
  });
  returnToOriginCheckbox.addEventListener('change', () => {
    if (returnToOriginCheckbox.checked) returnTripCheckbox.checked = false;
    updateReturnTripFields();
  });
  
  ['origin-address', 'dest-address'].forEach((id, index) => {
    document.getElementById(id).addEventListener('input', (e) => {
      if(index === 0) routes[0].originName = e.target.value;
      else routes[0].destinationName = e.target.value;
    });
  });

  // Event listeners for filters
  ['search-quotations', 'filter-client', 'filter-status', 'filter-date-start', 'filter-date-end'].forEach(id => {
    const el = document.getElementById(id);
    const event = el.tagName === 'SELECT' ? 'change' : 'input';
    el.addEventListener(event, populateQuotations);
  });
  
  document.getElementById('clear-filters')?.addEventListener('click', () => {
    document.getElementById('search-quotations').value = '';
    document.getElementById('filter-client').value = '';
    document.getElementById('filter-status').value = '';
    document.getElementById('filter-date-range').value = '';
    document.getElementById('filter-date-start').value = '';
    document.getElementById('filter-date-end').value = '';
    document.getElementById('custom-date-range').classList.add('hidden');
    populateQuotations();
  });

  // Event Listeners for Payment Statement Modal
  document.getElementById('payment-client-filter').addEventListener('change', filterPaymentQuotations);
  document.getElementById('payment-date-start').addEventListener('change', filterPaymentQuotations);
  document.getElementById('payment-date-end').addEventListener('change', filterPaymentQuotations);


  // Progress bar logic
  const nav = document.querySelector('nav');
  const progressBar = document.getElementById('progress-bar');
  progressBar.style.top = `${nav.offsetHeight}px`;
  window.addEventListener('scroll', () => {
    const scrollTop = document.documentElement.scrollTop;
    const scrollHeight = document.documentElement.scrollHeight - document.documentElement.clientHeight;
    progressBar.style.width = `${(scrollTop / scrollHeight) * 100}%`;
  });
});
// --- END APPLICATION LOGIC SCRIPT ---
  </script>
</body>
</html>