<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nativa Green - Sistema de Cotizaciones</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
  <style>
    #map { height: 400px; }
    .modal { display: none; }
    .modal.active { display: flex; }

    /* Custom color from request */
    .bg-nativa-green { background-color: #1E3B14; }
    .bg-nativa-green:hover { background-color: #2a521e; } /* Slightly lighter for hover */
    .text-nativa-green { color: #1E3B14; }
    .border-nativa-green { border-color: #1E3B14; }
  </style>
</head>
<body class="bg-gray-100 font-sans">
  <!-- Navbar -->
  <nav class="bg-nativa-green text-white p-4 shadow-lg">
    <div class="container mx-auto flex justify-between items-center">
      <img src="https://www.nativagreen.cl/imagenes/logo.png" alt="Nativa Green Logo" class="h-10">
      <div>
        <button onclick="showSection('dashboard')" class="px-4 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors">Dashboard</button>
        <button onclick="showSection('clients')" class="px-4 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors">Clientes</button>
        <button onclick="showSection('tariffs')" class="px-4 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors">Tarifas</button>
        <button onclick="showSection('create-quotation')" class="px-4 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors">Crear Cotización</button>
        <button onclick="showSection('others')" class="px-4 py-2 rounded-md hover:bg-white hover:bg-opacity-20 transition-colors">Otros</button>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="container mx-auto p-4">
    <!-- Dashboard -->
    <section id="dashboard" class="section">
      <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-nativa-green text-nativa-green">Dashboard</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h3 class="text-lg text-gray-600">Cotizaciones Abiertas</h3>
          <p class="text-3xl font-semibold mt-2">5</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h3 class="text-lg text-gray-600">Cotizaciones Aprobadas</h3>
          <p class="text-3xl font-semibold mt-2">3</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h3 class="text-lg text-gray-600">Órdenes Generadas</h3>
          <p class="text-3xl font-semibold mt-2">2</p>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <h3 class="text-lg text-gray-600">Ventas Concretadas</h3>
          <p class="text-3xl font-semibold mt-2">$150,000</p>
        </div>
      </div>
      <h3 class="text-xl mt-8 mb-4 font-bold text-gray-700">Cotizaciones Recientes</h3>
      <table class="w-full bg-white rounded-lg shadow-md overflow-hidden">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-3 text-left">Código</th>
            <th class="p-3 text-left">Cliente</th>
            <th class="p-3 text-left">Total</th>
            <th class="p-3 text-left">Estado</th>
            <th class="p-3 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody id="quotations-table">
          <!-- Llenado por JS -->
        </tbody>
      </table>
    </section>

    <!-- Clientes -->
    <section id="clients" class="section hidden">
      <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-nativa-green text-nativa-green">Clientes</h2>
      <button onclick="openClientModal('new')" class="bg-nativa-green text-white px-4 py-2 rounded-md mb-4 transition-colors">Nuevo Cliente</button>
      <table class="w-full bg-white rounded-lg shadow-md overflow-hidden">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-3 text-left">Nombre</th>
            <th class="p-3 text-left">RUC</th>
            <th class="p-3 text-left">Contacto</th>
            <th class="p-3 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody id="clients-table">
          <!-- Llenado por JS -->
        </tbody>
      </table>
    </section>

    <!-- Tarifas -->
    <section id="tariffs" class="section hidden">
      <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-nativa-green text-nativa-green">Tarifas</h2>
      <button onclick="openTariffModal('new')" class="bg-nativa-green text-white px-4 py-2 rounded-md mb-4 transition-colors">Nueva Tarifa</button>
      <table class="w-full bg-white rounded-lg shadow-md overflow-hidden">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-3 text-left">Nombre</th>
            <th class="p-3 text-left">Cliente</th>
            <th class="p-3 text-left">Contenedor</th>
            <th class="p-3 text-left">Precio/km</th>
            <th class="p-3 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody id="tariffs-table">
          <!-- Llenado por JS -->
        </tbody>
      </table>
    </section>

    <!-- Crear Cotización -->
    <section id="create-quotation" class="section hidden">
      <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-nativa-green text-nativa-green">Crear Cotización</h2>
      <form id="quotation-form" class="bg-white p-6 rounded-lg shadow-md">
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Cliente</label>
          <select id="client-id" class="w-full p-2 border rounded-md"></select>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Tarifa</label>
          <select id="tariff-id" class="w-full p-2 border rounded-md">
            <option value="">Seleccionar Tarifa</option>
          </select>
        </div>
        <div class="mb-4 bg-gray-50 p-4 rounded-md border">
          <label class="block text-sm font-bold mb-2">Detalles de la Tarifa</label>
          <div id="tariff-details" class="text-sm grid grid-cols-2 gap-2">
            <p><strong>Contenedor:</strong> <span id="tariff-container">N/A</span></p>
            <p><strong>Camión:</strong> <span id="tariff-truck">N/A</span></p>
            <p><strong>Precio por Km:</strong> <span id="tariff-price-per-km">0</span> CLP</p>
            <p><strong>Precio Contenedor:</strong> <span id="tariff-price-container">0</span> CLP</p>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div>
            <label class="block text-sm font-bold mb-2">Origen</label>
            <input id="origin-address" type="text" class="w-full p-2 border rounded-md" placeholder="Ingrese el lugar de origen">
          </div>
          <div>
            <label class="block text-sm font-bold mb-2">Destino</label>
            <input id="dest-address" type="text" class="w-full p-2 border rounded-md" placeholder="Ingrese el lugar de destino">
          </div>
        </div>
        <div class="mb-4 flex items-center">
          <label class="block text-sm font-bold mr-2">Km</label>
          <input id="km" type="number" class="w-1/2 p-2 border rounded-md" placeholder="Kilómetros">
          <button type="button" onclick="openMapModal(0)" class="bg-blue-500 text-white px-4 py-2 rounded-md ml-2 hover:bg-blue-600 transition-colors">Seleccionar en Mapa</button>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2"><input type="checkbox" id="return-trip" class="mr-2"> Incluir Vuelta</label>
          <label class="block text-sm font-bold mb-2"><input type="checkbox" id="return-to-origin" class="mr-2"> Volver al Origen (x2 distancia)</label>
        </div>
        <div id="additional-destinations" class="mb-4"></div>
        <div id="calculation-details" class="mb-4 border-t pt-4 mt-4"></div>
        <button type="submit" class="bg-nativa-green text-white px-4 py-2 rounded-md transition-colors">Guardar Cotización</button>
        <button type="button" onclick="generatePDF()" class="bg-gray-600 text-white px-4 py-2 rounded-md ml-2 hover:bg-gray-700 transition-colors">Exportar PDF</button>
      </form>
    </section>

    <!-- Others Section -->
    <section id="others" class="section hidden">
      <h2 class="text-2xl font-bold mb-4 pb-2 border-b-2 border-nativa-green text-nativa-green">Otros</h2>
      <!-- Containers -->
      <h3 class="text-xl font-bold mb-4 text-gray-700">Contenedores</h3>
      <button onclick="openContainerModal('new')" class="bg-nativa-green text-white px-4 py-2 rounded-md mb-4 transition-colors">Nuevo Contenedor</button>
      <table class="w-full bg-white rounded-lg shadow-md overflow-hidden mb-8">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-3 text-left">Nombre</th>
            <th class="p-3 text-left">Precio Base</th>
            <th class="p-3 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody id="containers-table">
          <!-- Filled by JS -->
        </tbody>
      </table>
      <!-- Trucks -->
      <h3 class="text-xl font-bold mb-4 text-gray-700">Camiones</h3>
      <button onclick="openTruckModal('new')" class="bg-nativa-green text-white px-4 py-2 rounded-md mb-4 transition-colors">Nuevo Camión</button>
      <table class="w-full bg-white rounded-lg shadow-md overflow-hidden">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-3 text-left">Nombre</th>
            <th class="p-3 text-left">Capacidad (Toneladas)</th>
            <th class="p-3 text-left">Acciones</th>
          </tr>
        </thead>
        <tbody id="trucks-table">
          <!-- Filled by JS -->
        </tbody>
      </table>
    </section>
  </div>

  <!-- Modals -->
  <div id="client-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/2">
      <h2 id="client-modal-title" class="text-xl font-bold mb-4">Nuevo Cliente</h2>
      <form id="client-form">
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Nombre</label><input id="client-name" type="text" class="w-full p-2 border rounded-md" required></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">RUC</label><input id="client-ruc" type="text" class="w-full p-2 border rounded-md"></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Contacto</label><input id="client-contact" type="text" class="w-full p-2 border rounded-md"></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Teléfono</label><input id="client-phone" type="text" class="w-full p-2 border rounded-md"></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Email</label><input id="client-email" type="email" class="w-full p-2 border rounded-md"></div>
        <button type="submit" class="bg-nativa-green text-white px-4 py-2 rounded-md transition-colors">Guardar</button>
        <button type="button" onclick="closeClientModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md ml-2 hover:bg-gray-700 transition-colors">Cerrar</button>
      </form>
    </div>
  </div>

  <div id="tariff-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/2">
      <h2 id="tariff-modal-title" class="text-xl font-bold mb-4">Nueva Tarifa</h2>
      <form id="tariff-form">
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Nombre</label><input id="tariff-name" type="text" class="w-full p-2 border rounded-md" required></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Cliente (opcional)</label><select id="tariff-client-id" class="w-full p-2 border rounded-md"><option value="">Global</option></select></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Contenedor</label><select id="tariff-container-id" class="w-full p-2 border rounded-md"></select></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Camión</label><select id="tariff-truck-id" class="w-full p-2 border rounded-md"></select></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Precio por Km</label><input id="tariff-price-per-km" type="number" step="0.01" class="w-full p-2 border rounded-md" required></div>
        <div class="mb-4"><label class="block text-sm font-bold mb-2">Precio Contenedor</label><input id="tariff-price-container" type="number" step="0.01" class="w-full p-2 border rounded-md" required></div>
        <button type="submit" class="bg-nativa-green text-white px-4 py-2 rounded-md transition-colors">Guardar</button>
        <button type="button" onclick="closeTariffModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md ml-2 hover:bg-gray-700 transition-colors">Cerrar</button>
      </form>
    </div>
  </div>

  <div id="container-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/2">
      <h2 id="container-modal-title" class="text-xl font-bold mb-4">Nuevo Contenedor</h2>
      <form id="container-form">
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Nombre</label>
          <input id="container-name" type="text" class="w-full p-2 border rounded-md" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Precio Base</label>
          <input id="container-base-price" type="number" step="0.01" class="w-full p-2 border rounded-md" required>
        </div>
        <button type="submit" class="bg-nativa-green text-white px-4 py-2 rounded-md transition-colors">Guardar</button>
        <button type="button" onclick="closeContainerModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md ml-2 hover:bg-gray-700 transition-colors">Cerrar</button>
      </form>
    </div>
  </div>

  <div id="truck-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-1/2">
      <h2 id="truck-modal-title" class="text-xl font-bold mb-4">Nuevo Camión</h2>
      <form id="truck-form">
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Nombre</label>
          <input id="truck-name" type="text" class="w-full p-2 border rounded-md" required>
        </div>
        <div class="mb-4">
          <label class="block text-sm font-bold mb-2">Capacidad (Toneladas)</label>
          <input id="truck-capacity" type="number" step="0.01" class="w-full p-2 border rounded-md" required>
        </div>
        <button type="submit" class="bg-nativa-green text-white px-4 py-2 rounded-md transition-colors">Guardar</button>
        <button type="button" onclick="closeTruckModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md ml-2 hover:bg-gray-700 transition-colors">Cerrar</button>
      </form>
    </div>
  </div>

  <div id="map-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
    <div class="bg-white p-6 rounded-lg shadow-xl w-3/4">
      <h2 class="text-xl font-bold mb-4">Seleccionar Ruta</h2>
      <div id="map" class="rounded-md border"></div>
      <div class="mt-4">
        <p><strong>Distancia:</strong> <span id="map-distance">0 km</span></p>
        <button onclick="confirmMapSelection()" class="bg-nativa-green text-white px-4 py-2 rounded-md mt-2 transition-colors">Confirmar</button>
        <button onclick="closeMapModal()" class="bg-gray-600 text-white px-4 py-2 rounded-md mt-2 ml-2 hover:bg-gray-700 transition-colors">Cerrar</button>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
  <script>
    // Datos simulados (en producción, vendrían de la API)
    const clients = [
      { id: 1, name: "Cliente A", ruc: "12345678-9", contactName: "Juan Pérez", contactPhone: "123456789", email: "juan@cliente.com" },
      { id: 2, name: "Cliente B", ruc: "98765432-1", contactName: "Ana Gómez", contactPhone: "987654321", email: "ana@cliente.com" },
    ];
    const containers = [
      { id: 1, name: "Contenedor 20 pies", basePrice: 50000 },
      { id: 2, name: "Contenedor 40 pies", basePrice: 80000 },
    ];
    const trucks = [
      { id: 1, name: "Camión 10T", capacityTons: 10 },
      { id: 2, name: "Camión 20T", capacityTons: 20 },
    ];
    const tariffs = [
      { id: 1, name: "Tarifa Estándar", clientId: null, containerId: 1, truckId: 1, pricePerKm: 1000, priceContainer: 50000 },
      { id: 2, name: "Tarifa Cliente A", clientId: 1, containerId: 1, truckId: 1, pricePerKm: 900, priceContainer: 45000 },
    ];
    const quotations = [
      { id: 1, code: "QUOT-001", clientId: 1, total: 150000, status: "draft" },
      { id: 2, code: "QUOT-002", clientId: 2, total: 200000, status: "approved" },
    ];

    // Estado para el mapa y rutas
    let map, waypoints = [], control;
    let routes = [
      { origin: null, originName: '', destination: null, destinationName: '', km: 0 }
    ];
    let currentRouteIndex = 0;

    // Mostrar secciones
    function showSection(sectionId) {
      document.querySelectorAll('.section').forEach(section => section.classList.add('hidden'));
      document.getElementById(sectionId).classList.remove('hidden');
    }

    // Llenar tablas y selects
    function populateClients() {
      const table = document.getElementById('clients-table');
      table.innerHTML = clients.map(client => `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3">${client.name}</td>
          <td class="p-3">${client.ruc || ''}</td>
          <td class="p-3">${client.contactName || ''}</td>
          <td class="p-3">
            <button onclick="openClientModal('edit', ${client.id})" class="text-blue-500 hover:underline">Editar</button>
            <button onclick="deleteClient(${client.id})" class="text-red-500 ml-2 hover:underline">Eliminar</button>
          </td>
        </tr>
      `).join('');

      const select = document.getElementById('client-id');
      select.innerHTML = '<option value="">Seleccionar Cliente</option>' + 
        clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('');

      const tariffSelect = document.getElementById('tariff-client-id');
      tariffSelect.innerHTML = '<option value="">Global</option>' + 
        clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('');
    }

    function populateTariffs() {
      const table = document.getElementById('tariffs-table');
      table.innerHTML = tariffs.map(tariff => `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3">${tariff.name}</td>
          <td class="p-3">${tariff.clientId ? clients.find(c => c.id === tariff.clientId)?.name : 'Global'}</td>
          <td class="p-3">${containers.find(c => c.id === tariff.containerId)?.name}</td>
          <td class="p-3">${tariff.pricePerKm}</td>
          <td class="p-3">
            <button onclick="openTariffModal('edit', ${tariff.id})" class="text-blue-500 hover:underline">Editar</button>
            <button onclick="deleteTariff(${tariff.id})" class="text-red-500 ml-2 hover:underline">Eliminar</button>
          </td>
        </tr>
      `).join('');

      const tariffSelect = document.getElementById('tariff-id');
      tariffSelect.innerHTML = '<option value="">Seleccionar Tarifa</option>' + 
        tariffs.map(tariff => {
          const clientName = tariff.clientId ? clients.find(c => c.id === tariff.clientId)?.name : 'Global';
          return `<option value="${tariff.id}">${tariff.name} (${clientName})</option>`;
        }).join('');

      const tariffContainerSelect = document.getElementById('tariff-container-id');
      tariffContainerSelect.innerHTML = '<option value="">Seleccionar Contenedor</option>' + 
        containers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

      const tariffTruckSelect = document.getElementById('tariff-truck-id');
      tariffTruckSelect.innerHTML = '<option value="">Seleccionar Camión</option>' + 
        trucks.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    function populateQuotations() {
      const table = document.getElementById('quotations-table');
      table.innerHTML = quotations.map(q => `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3">${q.code}</td>
          <td class="p-3">${clients.find(c => c.id === q.clientId)?.name}</td>
          <td class="p-3">${q.total}</td>
          <td class="p-3">${q.status}</td>
          <td class="p-3">
            <button onclick="viewQuotation(${q.id})" class="text-blue-500 hover:underline">Ver</button>
            <button onclick="generatePDF(${q.id})" class="text-green-500 ml-2 hover:underline">PDF</button>
          </td>
        </tr>
      `).join('');
    }

    function populateContainers() {
      const table = document.getElementById('containers-table');
      table.innerHTML = containers.map(container => `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3">${container.name}</td>
          <td class="p-3">${container.basePrice}</td>
          <td class="p-3">
            <button onclick="openContainerModal('edit', ${container.id})" class="text-blue-500 hover:underline">Editar</button>
            <button onclick="deleteContainer(${container.id})" class="text-red-500 ml-2 hover:underline">Eliminar</button>
          </td>
        </tr>
      `).join('');
    }

    function populateTrucks() {
      const table = document.getElementById('trucks-table');
      table.innerHTML = trucks.map(truck => `
        <tr class="border-b hover:bg-gray-50">
          <td class="p-3">${truck.name}</td>
          <td class="p-3">${truck.capacityTons}</td>
          <td class="p-3">
            <button onclick="openTruckModal('edit', ${truck.id})" class="text-blue-500 hover:underline">Editar</button>
            <button onclick="deleteTruck(${truck.id})" class="text-red-500 ml-2 hover:underline">Eliminar</button>
          </td>
        </tr>
      `).join('');
    }

    // Modal Clientes
    let currentClientId = null;
    function openClientModal(mode, id = null) {
      currentClientId = id;
      document.getElementById('client-modal-title').textContent = mode === 'new' ? 'Nuevo Cliente' : 'Editar Cliente';
      if (id) {
        const client = clients.find(c => c.id === id);
        document.getElementById('client-name').value = client.name;
        document.getElementById('client-ruc').value = client.ruc || '';
        document.getElementById('client-contact').value = client.contactName || '';
        document.getElementById('client-phone').value = client.contactPhone || '';
        document.getElementById('client-email').value = client.email || '';
      } else {
        document.getElementById('client-form').reset();
      }
      document.getElementById('client-modal').classList.add('active');
    }

    function closeClientModal() {
      document.getElementById('client-modal').classList.remove('active');
    }

    document.getElementById('client-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const client = {
        id: currentClientId || Date.now(),
        name: document.getElementById('client-name').value,
        ruc: document.getElementById('client-ruc').value,
        contactName: document.getElementById('client-contact').value,
        contactPhone: document.getElementById('client-phone').value,
        email: document.getElementById('client-email').value,
      };
      if (currentClientId) {
        clients[clients.findIndex(c => c.id === currentClientId)] = client;
      } else {
        clients.push(client);
      }
      populateClients();
      closeClientModal();
    });

    function deleteClient(id) {
      if (confirm('¿Eliminar cliente?')) {
        clients.splice(clients.findIndex(c => c.id === id), 1);
        populateClients();
      }
    }

    // Modal Tarifas
    let currentTariffId = null;
    function openTariffModal(mode, id = null) {
      currentTariffId = id;
      document.getElementById('tariff-modal-title').textContent = mode === 'new' ? 'Nueva Tarifa' : 'Editar Tarifa';
      if (id) {
        const tariff = tariffs.find(t => t.id === id);
        document.getElementById('tariff-name').value = tariff.name;
        document.getElementById('tariff-client-id').value = tariff.clientId || '';
        document.getElementById('tariff-container-id').value = tariff.containerId;
        document.getElementById('tariff-truck-id').value = tariff.truckId;
        document.getElementById('tariff-price-per-km').value = tariff.pricePerKm;
        document.getElementById('tariff-price-container').value = tariff.priceContainer;
      } else {
        document.getElementById('tariff-form').reset();
      }
      document.getElementById('tariff-modal').classList.add('active');
    }

    function closeTariffModal() {
      document.getElementById('tariff-modal').classList.remove('active');
    }

    document.getElementById('tariff-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const tariff = {
        id: currentTariffId || Date.now(),
        name: document.getElementById('tariff-name').value,
        clientId: document.getElementById('tariff-client-id').value || null,
        containerId: parseInt(document.getElementById('tariff-container-id').value),
        truckId: parseInt(document.getElementById('tariff-truck-id').value),
        pricePerKm: parseFloat(document.getElementById('tariff-price-per-km').value),
        priceContainer: parseFloat(document.getElementById('tariff-price-container').value),
      };
      if (currentTariffId) {
        tariffs[tariffs.findIndex(t => t.id === currentTariffId)] = tariff;
      } else {
        tariffs.push(tariff);
      }
      populateTariffs();
      closeTariffModal();
    });

    function deleteTariff(id) {
      if (confirm('¿Eliminar tarifa?')) {
        tariffs.splice(tariffs.findIndex(t => t.id === id), 1);
        populateTariffs();
      }
    }

    // Modal Contenedores
    let currentContainerId = null;
    function openContainerModal(mode, id = null) {
      currentContainerId = id;
      document.getElementById('container-modal-title').textContent = mode === 'new' ? 'Nuevo Contenedor' : 'Editar Contenedor';
      if (id) {
        const container = containers.find(c => c.id === id);
        document.getElementById('container-name').value = container.name;
        document.getElementById('container-base-price').value = container.basePrice;
      } else {
        document.getElementById('container-form').reset();
      }
      document.getElementById('container-modal').classList.add('active');
    }

    function closeContainerModal() {
      document.getElementById('container-modal').classList.remove('active');
    }

    document.getElementById('container-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const container = {
        id: currentContainerId || Date.now(),
        name: document.getElementById('container-name').value,
        basePrice: parseFloat(document.getElementById('container-base-price').value),
      };
      if (currentContainerId) {
        containers[containers.findIndex(c => c.id === currentContainerId)] = container;
      } else {
        containers.push(container);
      }
      populateContainers();
      populateTariffs();
      closeContainerModal();
    });

    function deleteContainer(id) {
      if (confirm('¿Eliminar contenedor?')) {
        containers.splice(containers.findIndex(c => c.id === id), 1);
        populateContainers();
        populateTariffs();
      }
    }

    // Modal Camiones
    let currentTruckId = null;
    function openTruckModal(mode, id = null) {
      currentTruckId = id;
      document.getElementById('truck-modal-title').textContent = mode === 'new' ? 'Nuevo Camión' : 'Editar Camión';
      if (id) {
        const truck = trucks.find(t => t.id === id);
        document.getElementById('truck-name').value = truck.name;
        document.getElementById('truck-capacity').value = truck.capacityTons;
      } else {
        document.getElementById('truck-form').reset();
      }
      document.getElementById('truck-modal').classList.add('active');
    }

    function closeTruckModal() {
      document.getElementById('truck-modal').classList.remove('active');
    }

    document.getElementById('truck-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const truck = {
        id: currentTruckId || Date.now(),
        name: document.getElementById('truck-name').value,
        capacityTons: parseFloat(document.getElementById('truck-capacity').value),
      };
      if (currentTruckId) {
        trucks[trucks.findIndex(t => t.id === currentTruckId)] = truck;
      } else {
        trucks.push(truck);
      }
      populateTrucks();
      populateTariffs();
      closeTruckModal();
    });

    function deleteTruck(id) {
      if (confirm('¿Eliminar camión?')) {
        trucks.splice(trucks.findIndex(t => t.id === id), 1);
        populateTrucks();
        populateTariffs();
      }
    }

    // Actualizar detalles de la tarifa seleccionada
    function updateTariffDetails() {
      const tariffId = parseInt(document.getElementById('tariff-id').value);
      const tariff = tariffs.find(t => t.id === tariffId);
      if (tariff) {
        document.getElementById('tariff-container').textContent = containers.find(c => c.id === tariff.containerId)?.name || 'N/A';
        document.getElementById('tariff-truck').textContent = trucks.find(t => t.id === tariff.truckId)?.name || 'N/A';
        document.getElementById('tariff-price-per-km').textContent = tariff.pricePerKm.toFixed(2);
        document.getElementById('tariff-price-container').textContent = tariff.priceContainer.toFixed(2);
      } else {
        document.getElementById('tariff-container').textContent = 'N/A';
        document.getElementById('tariff-truck').textContent = 'N/A';
        document.getElementById('tariff-price-per-km').textContent = '0';
        document.getElementById('tariff-price-container').textContent = '0';
      }
      calculateQuotation();
    }

    // Manejar rutas dinámicas
    function updateReturnTripFields() {
      const returnTrip = document.getElementById('return-trip').checked;
      const returnToOrigin = document.getElementById('return-to-origin').checked;
      const additionalDestinations = document.getElementById('additional-destinations');
      additionalDestinations.innerHTML = '';

      if (returnTrip && !returnToOrigin) {
        routes[1] = routes[1] || { origin: routes[0].destination, originName: routes[0].destinationName, destination: null, destinationName: '', km: 0 };
        additionalDestinations.innerHTML = `
          <div class="mb-4">
            <label class="block text-sm font-bold mb-2">Destino de Vuelta</label>
            <input id="dest-address-1" type="text" class="w-full p-2 border rounded" placeholder="Ingrese el nombre del destino de vuelta" value="${routes[1].destinationName || ''}">
          </div>
          <div class="mb-4 flex items-center">
            <label class="block text-sm font-bold mr-2">Km de Vuelta</label>
            <input id="km-1" type="number" class="w-1/2 p-2 border rounded" placeholder="Kilómetros" value="${routes[1].km || ''}">
            <button type="button" onclick="openMapModal(1)" class="bg-blue-500 text-white px-4 py-2 rounded ml-2">Seleccionar en Mapa</button>
          </div>
        `;
        document.getElementById('dest-address-1').addEventListener('input', () => {
          routes[1].destinationName = document.getElementById('dest-address-1').value;
        });
        document.getElementById('km-1').addEventListener('input', () => {
          const kmValue = Math.round(parseFloat(document.getElementById('km-1').value) || 0);
          routes[1].km = kmValue;
          document.getElementById('km-1').value = kmValue;
          calculateQuotation();
        });
      } else {
        routes = [routes[0]];
      }
      calculateQuotation();
    }

    // Mapa con Leaflet Routing Machine
    function openMapModal(routeIndex) {
      currentRouteIndex = routeIndex;
      document.getElementById('map-modal').classList.add('active');
      
      setTimeout(() => {
        if (!map) {
          map = L.map('map').setView([-33.4489, -70.6693], 13); // Santiago, Chile
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
        } else {
          map.invalidateSize();
        }

        waypoints = [];
        if (control) {
          map.removeControl(control);
          control = null;
        }
        map.eachLayer(function (layer) {
          if (layer instanceof L.Marker) {
            map.removeLayer(layer);
          }
        });

        document.getElementById('map-distance').textContent = '0 km';

        if (routeIndex === 1 && routes[0].destination) {
          waypoints.push(routes[0].destination);
          L.marker(routes[0].destination).addTo(map).bindPopup(`Origen: ${routes[0].destinationName || 'Destino Anterior'}`).openPopup();
        }

        map.on('click', function(e) {
          if (waypoints.length < 2) {
            if (routeIndex === 1 && waypoints.length === 0) return;
            waypoints.push(L.latLng(e.latlng.lat, e.latlng.lng));
            const pointLabel = waypoints.length === 1 && routeIndex === 0 ? 'Origen' : 'Destino';
            L.marker(e.latlng).addTo(map).bindPopup(pointLabel).openPopup();
            if (waypoints.length === 2) {
              if (control) {
                map.removeControl(control);
              }
              control = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                show: false,
                addWaypoints: false,
                lineOptions: { styles: [{ color: 'blue', opacity: 0.7, weight: 5 }] },
                createMarker: function() { return null; }
              }).addTo(map);

              control.on('routesfound', function(ev) {
                var distancia = ev.routes[0].summary.totalDistance / 1000;
                document.getElementById('map-distance').textContent = `${distancia.toFixed(2)} km`;
              });
            }
          }
        });
      }, 100);
    }

    function closeMapModal() {
      document.getElementById('map-modal').classList.remove('active');
      if (map) {
        map.off('click');
      }
    }

    function confirmMapSelection() {
      if (waypoints.length === 2) {
        const distancia = parseFloat(document.getElementById('map-distance').textContent);
        const roundedDistance = Math.round(distancia);
        routes[currentRouteIndex].origin = waypoints[0];
        routes[currentRouteIndex].destination = waypoints[1];
        routes[currentRouteIndex].km = roundedDistance;

        if (currentRouteIndex === 0) {
          routes[0].originName = routes[0].originName || prompt('Ingrese el nombre del lugar de origen:', 'Origen') || 'Origen';
          routes[0].destinationName = routes[0].destinationName || prompt('Ingrese el nombre del lugar de destino:', 'Destino') || 'Destino';
          document.getElementById('origin-address').value = routes[0].originName;
          document.getElementById('dest-address').value = routes[0].destinationName;
        } else if (currentRouteIndex === 1) {
          routes[1].destinationName = routes[1].destinationName || prompt('Ingrese el nombre del lugar de destino de vuelta:', 'Destino Vuelta') || 'Destino Vuelta';
          document.getElementById('dest-address-1').value = routes[1].destinationName;
        }

        if (currentRouteIndex === 0 && routes[1]) {
          routes[1].origin = waypoints[1];
          routes[1].originName = routes[0].destinationName;
          if (document.getElementById('dest-address-1')) {
            document.getElementById('dest-address-1').value = routes[1].destinationName;
          }
        }

        document.getElementById(`km${currentRouteIndex ? '-' + currentRouteIndex : ''}`).value = roundedDistance;
        closeMapModal();
        calculateQuotation();
      } else {
        alert('Selecciona dos puntos en el mapa para calcular la distancia.');
      }
    }

    // Calcular cotización
    function calculateQuotation() {
      const clientId = parseInt(document.getElementById('client-id').value);
      const tariffId = parseInt(document.getElementById('tariff-id').value);
      const returnTrip = document.getElementById('return-trip').checked;
      const returnToOrigin = document.getElementById('return-to-origin').checked;

      const tariff = tariffs.find(t => t.id === tariffId);
      if (!tariff) {
        document.getElementById('calculation-details').innerHTML = '<p class="text-red-500 font-bold">Seleccione una tarifa válida para calcular.</p>';
        return;
      }

      let totalKm = 0;
      let costoKmDetails = '';
      const kmInput = document.getElementById('km');
      let km = routes[0].km || (kmInput ? Math.round(parseFloat(kmInput.value) || 0) : 0);

      if (returnToOrigin) {
        // Si "Volver al Origen" está seleccionado, duplicar la distancia del tramo principal
        totalKm = km * 2;
        costoKmDetails = `<p><strong>Costo Tramo Ida y Vuelta (${totalKm} km):</strong> ${(tariff.pricePerKm * totalKm).toFixed(0)} CLP</p>`;
      } else if (returnTrip) {
        // Si "Incluir Vuelta" está seleccionado, sumar los kilómetros de ambos tramos
        totalKm = km;
        costoKmDetails = `<p><strong>Costo Tramo Ida (${km} km):</strong> ${(tariff.pricePerKm * km).toFixed(0)} CLP</p>`;
        if (routes[1]) {
          const kmReturn = routes[1].km || (document.getElementById('km-1') ? Math.round(parseFloat(document.getElementById('km-1').value) || 0) : 0);
          totalKm += kmReturn;
          costoKmDetails += `<p><strong>Costo Tramo Vuelta (${kmReturn} km):</strong> ${(tariff.pricePerKm * kmReturn).toFixed(0)} CLP</p>`;
        }
      } else {
        // Solo el tramo principal
        totalKm = km;
        costoKmDetails = `<p><strong>Costo Tramo Ida (${km} km):</strong> ${(tariff.pricePerKm * km).toFixed(0)} CLP</p>`;
      }

      const costoContenedor = tariff.priceContainer;
      const subtotal = (tariff.pricePerKm * totalKm) + costoContenedor;
      const iva = subtotal * 0.19;
      const total = subtotal + iva;

      document.getElementById('calculation-details').innerHTML = `
        <h4 class="text-md font-bold mb-2">Resumen de Cotización</h4>
        <div class="space-y-1 text-sm">
          ${costoKmDetails}
          <p><strong>Costo Base Contenedor:</strong> ${costoContenedor.toFixed(0)} CLP</p>
          <p class="font-semibold mt-2 pt-2 border-t"><strong>Subtotal:</strong> ${subtotal.toFixed(0)} CLP</p>
          <p><strong>IVA (19%):</strong> ${iva.toFixed(0)} CLP</p>
          <p class="text-lg font-bold text-nativa-green"><strong>Total:</strong> ${total.toFixed(0)} CLP</p>
        </div>
      `;
    }

    document.getElementById('quotation-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const tariffId = parseInt(document.getElementById('tariff-id').value);
      if (!tariffId) {
        alert('Por favor, seleccione una tarifa válida.');
        return;
      }
      const quotation = {
        id: Date.now(),
        code: `QUOT-${Date.now()}`,
        clientId: parseInt(document.getElementById('client-id').value),
        tariffId: tariffId,
        total: parseFloat(document.querySelector('#calculation-details strong:last-child').textContent.replace(' CLP', '')),
        status: 'draft',
      };
      quotations.push(quotation);
      populateQuotations();
      alert('Cotización guardada.');
    });

    function generatePDF(id) {
      alert(`Generando PDF para cotización ${id}... (Implementar con jsPDF o backend)`);
    }

    function viewQuotation(id) {
      alert(`Mostrando detalles de cotización ${id}... (Implementar vista detallada)`);
    }

    // Inicializar
    document.addEventListener('DOMContentLoaded', () => {
      populateClients();
      populateTariffs();
      populateQuotations();
      populateContainers();
      populateTrucks();
      showSection('dashboard');

      document.getElementById('client-id').addEventListener('change', () => {
        updateTariffDetails();
        calculateQuotation();
      });
      document.getElementById('tariff-id').addEventListener('change', () => {
        updateTariffDetails();
        calculateQuotation();
      });
      document.getElementById('km').addEventListener('input', () => {
        const kmValue = Math.round(parseFloat(document.getElementById('km').value) || 0);
        routes[0].km = kmValue;
        document.getElementById('km').value = kmValue;
        calculateQuotation();
      });
      document.getElementById('return-trip').addEventListener('change', updateReturnTripFields);
      document.getElementById('return-to-origin').addEventListener('change', updateReturnTripFields);
      document.getElementById('origin-address').addEventListener('input', () => {
        routes[0].originName = document.getElementById('origin-address').value;
      });
      document.getElementById('dest-address').addEventListener('input', () => {
        routes[0].destinationName = document.getElementById('dest-address').value;
        if (routes[1]) {
          routes[1].originName = routes[0].destinationName;
          if (document.getElementById('dest-address-1')) {
            document.getElementById('dest-address-1').value = routes[1].destinationName;
          }
        }
      });
    });
  </script>
</body>
</html>